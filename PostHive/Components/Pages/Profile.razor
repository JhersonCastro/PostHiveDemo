@page "/Profile"
@using PostHive.Services
@inject ISnackbar Snackbar

@inject UserState UserState
@inject PostService PostService
@inject NavigationManager NavigationManager
@inject IWebHostEnvironment WebHotEnv
@inject UserService UserService
@inject CookiesService CookiesService

<div>
    @if (!string.IsNullOrEmpty(_error))
    {
        <p class="text-danger">Error: @_error</p>
    }
</div>

@if (UserState.CurrentUser==null)
{
    <PostHive.Components.Pages.Tags.Utils.SpinCircle></PostHive.Components.Pages.Tags.Utils.SpinCircle>
}else
{
    <PageTitle>@UserState.CurrentUser.Name</PageTitle>
        
    <PostHive.Components.Pages.Tags.Utils.UserHeader 
    _userContext="UserState.CurrentUser" 
    uploadFiles="BtnAvatarHandlerAsync"
    />


    <MudContainer MaxWidth="MaxWidth.Medium" Class="my-5">
        <MudGrid>
            <MudItem xs="12">
                <MudPaper Elevation="4" Class="p-4">
                    <!-- Formulario de edición -->
                    <EditForm EditContext="_editPostContext" OnValidSubmit="HandlerPost">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <!-- Selección de privacidad usando MudSelect -->
                        <MudSelect T="PostPrivacy" Label="Privacy" @bind-Value="_postModel!.Privacy" Margin="Margin.Normal">
                            @foreach (var value in Enum.GetValues<PostPrivacy>())
                            {
                                <MudSelectItem Value="@value">@value</MudSelectItem>
                            }
                        </MudSelect>

                        <!-- Campo de texto para el contenido -->
                        <MudTextField T="string" Lines="3" Placeholder="Write something..." Label="Body" @bind-Value="_postModel.Body" Margin="Margin.Normal" />

                        <!-- Acciones: carga de archivos y botón de envío -->
                        <MudGrid Justify="Justify.FlexEnd" AlignItems="Center" Class="mt-2">
                            <!-- Carga de archivos -->
                            <MudItem>
                                <MudFileUpload 
                                    T="IReadOnlyList<IBrowserFile>" 
                                        FilesChanged="BtnUploadPostFiles" 
                                        Accept=".png,.jpg,.jpeg,.mp4" 
                                        MaximumFileCount="@Const.MaxFileCount">
                                    <ActivatorContent>
                                        <MudIcon Icon="@Icons.Material.Rounded.FileUpload" Class="mud-icon-size-large IconHover" />
                                    </ActivatorContent>
                                </MudFileUpload>
                            </MudItem>

                            <!-- Botón de submit dentro de un tooltip -->
                            <MudItem>
                                <MudTooltip Text="Post">
                                    <MudFab Color="Color.Primary" StartIcon="@Icons.Material.Outlined.Publish" ButtonType="ButtonType.Submit" />
                                </MudTooltip>
                            </MudItem>
                        </MudGrid>
                    </EditForm>

                    <!-- Sección de progreso de subida -->
                    <MudPaper Class="mt-4 p-3" Elevation="1">
                        @if (_currentUploadFiles > 0)
                        {
                            <MudText Typo="Typo.subtitle2">
                                Please don't close this page, Uploading @_currentUploadFiles file(s)
                            </MudText>
                        }
                        @foreach (var file in _fileProgresses.Keys)
                        {
                            <MudProgressLinear Value="@_fileProgresses[file]" BufferValue="100" Color="Color.Primary" Class="mt-2" />
                            <!-- También se muestra el porcentaje con formato -->
                            <MudText Typo="Typo.caption">@($"{_fileProgresses[file]:0.00}%")</MudText>
                        }
                    </MudPaper>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudContainer>
    <div style="margin-top: 3rem;"></div>
    <PostHive.Components.Pages.Tags.Posts.PostSection 
        UserContext="UserState.CurrentUser"
        CurrentUser="UserState.CurrentUser"/>


}

<style>
    .IconHover:hover{
    cursor: pointer;
    }
</style>